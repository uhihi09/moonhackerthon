<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeGuard - ë§ˆì´í˜ì´ì§€</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav class="navbar">
    <div class="navbar-container">
        <div class="nav-brand">
            <span>ğŸ†˜</span> SafeGuard
        </div>
        <ul class="nav-menu">
            <li><a href="/dashboard.html">í™ˆ</a></li>
            <li><a href="/contacts.html">ê¸´ê¸‰ ì—°ë½ì²˜</a></li>
            <li><a href="/history.html">ì‹ ê³  ë‚´ì—­</a></li>
            <li><a href="/location.html">ì´ë™ ê²½ë¡œ</a></li>
            <li><a href="/profile.html" class="active">ë§ˆì´í˜ì´ì§€</a></li>
            <li><a href="#" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a></li>
        </ul>
    </div>
</nav>

<div class="container">
    <div class="dashboard-header">
        <h1>ğŸ‘¤ ë§ˆì´í˜ì´ì§€</h1>
        <p>ë‚´ ì •ë³´ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
    </div>

    <!-- ë‚´ ì •ë³´ -->
    <div class="card">
        <h3>ğŸ“‹ ë‚´ ì •ë³´</h3>
        <form id="profileForm">
            <div class="form-group">
                <label for="profileName">ì´ë¦„</label>
                <input type="text" id="profileName" required>
            </div>

            <div class="form-group">
                <label for="profilePhone">ì „í™”ë²ˆí˜¸</label>
                <input type="tel" id="profilePhone" required>
            </div>

            <div class="form-group">
                <label for="profileUsername">ì•„ì´ë””</label>
                <input type="text" id="profileUsername" disabled>
            </div>

            <button type="submit" class="btn btn-primary">ì •ë³´ ìˆ˜ì •</button>
        </form>
    </div>

    <!-- í†µê³„ -->
    <div class="card">
        <h3>ğŸ“Š ì‚¬ìš© í†µê³„</h3>
        <div id="userStats">
            <p>ì´ ê¸´ê¸‰ ì‹ ê³  íšŸìˆ˜: <strong id="totalReports">0</strong>íšŒ</p>
            <p>ë“±ë¡ëœ ê¸´ê¸‰ ì—°ë½ì²˜: <strong id="totalContacts">0</strong>ëª…</p>
            <p>ìœ„ì¹˜ ê¸°ë¡: <strong id="totalLocations">0</strong>ê°œ</p>
        </div>
    </div>
</div>

<script src="/js/api.js"></script>
<script>
    checkAuth();

    // ë¡œê·¸ì•„ì›ƒ
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
        e.preventDefault();
        if (showConfirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            localStorage.removeItem('authToken');
            localStorage.removeItem('username');
            window.location.href = '/index.html';
        }
    });

    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
    async function loadProfile() {
        try {
            const user = await apiCall('/users/me');
            document.getElementById('profileName').value = user.name || '';
            document.getElementById('profilePhone').value = user.phone || '';
            document.getElementById('profileUsername').value = user.username || '';
        } catch (error) {
            showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ì •ë³´ ìˆ˜ì •
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('profileName').value;
        const phone = document.getElementById('profilePhone').value;

        try {
            await apiCall('/users/me', 'PUT', { name, phone });
            showSuccess('ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } catch (error) {
            showError('ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });

    // í†µê³„ ë¡œë“œ
    async function loadStats() {
        try {
            const [reports, contacts, locations] = await Promise.all([
                apiCall('/emergency-reports/my'),
                apiCall('/emergency-contacts'),
                apiCall('/locations/my')
            ]);

            document.getElementById('totalReports').textContent = reports.length;
            document.getElementById('totalContacts').textContent = contacts.length;
            document.getElementById('totalLocations').textContent = locations.length;
        } catch (error) {
            console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    loadProfile();
    loadStats();
</script>
</body>
</html>